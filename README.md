## Описание работы системы

Система предварительной водоподготовки представляет собой две 200л бочки, которые работают 
поочереди. Главная цель системы заключается в обеспечении достаточно длительного (больше двух часов)
контактного взаимодйествия воды с гипохлоридом натрия, чтобы окислить все органические и 
неорганические вещества, удалить сероводород и аммиак.

Каждая из двух бочек обвязана двумя трубами с входным и выходным моторизованными шаровыми кранами.
В каждой бочке находится два поплавковых датчика: полного заполнения и полного опустошения.
Помимо этого, каждая бочка оснащена поплавковым выключателем, задача которого обесточить
входной насос в аварийном случае отказа контроллера/кранов для предотвращения затопления помещения.

В основном - рабочем - режиме оба ВХОДНЫХ крана закрыты. У одной из бочек ВЫХОДНОЙ кран открыт, у другой закрыт.
Выходной насос качает воду из бочки. 
При откачке сначала сработает верхний поплавковый датчик.
Датчик слеп, он всего лишь говорит об отсутсвии воды, однако, он расположен высоко и вода еще есть.
Поэтому этот сигнал игнорируется.
По истечении неопределенного времени сработает нижний поплавковый датчик.
Бочка оказывается действительно пустой. Сигнал с нижнего поплавкового датчика является 
триггером переключения бочек, заполнения опустевшей бочки и дозации гипохлорида.
Обозначенные режимы активируются и выполняются асинхронно.

### Режимы работы системы

* Инициализация
* Расход воды (основной)
* Переключение бочек
* Заполнение бочек
* Дозация гипохлорида натрия
* Аварийный

#### Инициализация

Выполняется при подаче питания на контроллер.
- опрос датчиков уровня
    - если обе бочки пустые, то: 
        - заполнить каждую
        - выполнить дозацию в каждую
        - выставить активную бочку
    - если обе бочки полные, то:
        - узнать, какая активная, ничего не менять
    - если одна полная, вторая расходуется, то:
        - узнать, какая активная, ничего не менять
    - если одна полная, вторая пустая:
        - выполнить переключение бочек
    - если обе расходуются
        - не предусмотрено

#### Рабочий режим

Основной цикл: 
- периодический опрос датчиков уровня

Во время расхода воды возникнет всего два события:
- опустится верхний поплавковый датчик (цепь замкнется), сигнал игнорируется
- опустится нижний поплавковый датчик (цепь замкнется)
- запуск переключения бочек

#### Переключение бочек

После получения сигнала с нижнего поплавкового датчика:

- ВЫХОДНОЙ кран полной бочки открывается
- ВЫХОДНОЙ кран пустой бочки закрывается
- запускается режим дозации
- запускается режим заполнения бочки

#### Заполнение бочек

- Контроллер открывает ВХОДНОЙ кран пустой бочки
- сигнал с нижнего поплавкового датчика игнорируется
- По сигналу с верхнего поплавкового дачтика (цепь размыкается), ВХОДНОЙ кран закрывается

#### Дозация гипохлорида

Дозация выполняется при помощи дозирующего насоса только при переключении бочек.
Насос получает импульс от контроллера и делает N впрысков на 200л воды. N рассчитывается
по формулам, исходя из загрязненности воды.

- контроллер отправляет ШИМ-сигнал на сервопривод, который наклоняет коромысло к пустой бочке
- контроллер отправляет импульс на насос, выполняется дозация в нужном объеме

#### Аварийный

Фаза и ноль силового кабеля входного насоса разрываются поплавковыми выключателями.
В рабочем режиме силовая цепь всегда замкнута и насос находится под напряжением.
При заклинивании/отказе моторизованных кранов, ошибке контроллера начнеться переполнение.
Любому из полпавков достаточно всплыть, чтобы разорвать фазу или ноль и обесточить насос.